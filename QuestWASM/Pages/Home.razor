@page "/"
@inject IStringLocalizer<Strings> Strings
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject ProjectQualityService ProjectService
@using System.IO
@using Qhta.Xml.Serialization
@using QuestRDM
@using Quest

<PageTitle>@Strings["Start"]</PageTitle>

<h1>@Strings["OpenFile"]</h1>

<div class="mb-3">
  <label for="fileInput" class="form-label">@Strings["SelectFile_"]</label>
  <InputFile id="fileInput" OnChange="HandleFileSelected" accept="@acceptedFileTypes" />
</div>

@if (!string.IsNullOrEmpty(fileName))
{
  <div class="alert alert-info">
    <strong>@Strings["SelectedFile_"]</strong> @fileName (@fileSize bytes)
  </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
  <div class="alert alert-danger">
    <strong>@Strings["Error_"]:</strong> @errorMessage
  </div>
}

@code {
  private string? acceptedFileTypes = ".xml,.zip,.xls,.xlsx,.xlsm";
  private string? fileName;
  private long fileSize;
  private string? errorMessage;

  private async Task HandleFileSelected(InputFileChangeEventArgs e)
  {
    errorMessage = null;
    var file = e.File;
    fileName = file.Name;
    fileSize = file.Size;

    var ext = Path.GetExtension(file.Name).ToLowerInvariant();
    if (ext.StartsWith(".xls"))
    {
      await HandleExcelFile(file);
    }
    else
    {
      await HandleQuestFile(file);
    }
  }

  private async Task HandleExcelFile(IBrowserFile file)
  {
    try
    {
      using var memoryStream = new MemoryStream();
      await file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024).CopyToAsync(memoryStream);
      memoryStream.Position = 0;

      errorMessage = "Excel import not yet implemented.";
    }
    catch (Exception ex)
    {
      errorMessage = ex.Message;
    }
  }

  private async Task HandleQuestFile(IBrowserFile file)
  {
    try
    {
      using var memoryStream = new MemoryStream();
      await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(memoryStream);
      memoryStream.Position = 0;
      var bytes = memoryStream.ToArray();

      ProjectQuality? projectQuality = 
      Path.GetExtension(file.Name).ToLowerInvariant().EndsWith("xml") ?
        await FileCommandHelper.DeserializeProjectAsync(bytes) :
        await FileCommandHelper.UnpackProjectAsync(bytes);
      if (projectQuality != null)
      {
        // Use the service to store the project
        ProjectService.LoadProject(projectQuality, fileName);

        // Navigate to QuestView
        Navigation.NavigateTo("/quest");
      }
      else
      {
        errorMessage = "Failed to deserialize project quality data";
      }
    }
    catch (Exception ex)
    {
      errorMessage = ex.Message;
      await JS.InvokeVoidAsync("console.error", "Error loading Quest file:", ex.ToString());
    }
  }
}