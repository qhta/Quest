@using Quest
@using System.ComponentModel
@implements IDisposable

@if (Factor != null)
{
  <tr class="factor-row-level-@Level" style="background-color: @GetBackgroundColor()">
    <td style="padding-left: @(Level * 20)px;">
      @Factor.DisplayNameWithNumbering
    </td>
    <td class="text-center">
      <input type="number"
             class="form-control form-control-sm"
             value="@Factor.Weight"
             @onchange="@(e => OnWeightChanged(e))"
             min="0"
             max="100"
             style="width: 70px;" />
    </td>
    <td>
      @if (Factor is QualityMeasureVM measure)
      {
        <!-- Grade selector for measures -->
        <select class="form-select form-select-sm"
                value="@measure.Grade"
                @onchange="@(e => OnGradeChanged(measure, e))">
          <option value="">--</option>
          @if (Scale != null)
          {
            @foreach (var grade in Scale)
            {
              <option value="@grade.Text">@grade.Text</option>
            }
          }
        </select>
      }
      else
      {
        <!-- Calculated value for factors/metrics -->
        <span class="d-block text-center">
          @(Factor.Value?.ToString("F2") ?? "-")
        </span>
      }
    </td>
    <td class="text-center">
      @(Factor.Reliability?.ToString("F2") ?? "-")
    </td>
    <td>
      <input type="text"
             class="form-control form-control-sm"
             value="@Factor.Comment"
             @onchange="@(e => OnCommentChanged(e))"
             placeholder="@Strings["Comment"]" />
    </td>
  </tr>

  <!-- Render children recursively -->
  @if (Factor is QualityFactorVM factorVM && factorVM.Children.Any())
  {
    @foreach (var child in factorVM.Children)
    {
      <QualityFactorRow Factor="child" Level="Level + 1" Scale="Scale" />
    }
  }
  else if (Factor is QualityMetricsVM metricsVM && metricsVM.Children.Any())
  {
    @foreach (var child in metricsVM.Children)
    {
      <QualityFactorRow Factor="child" Level="Level + 1" Scale="Scale" />
    }
  }
}

@code {
  [Parameter]
  public IQualityNodeVM? Factor { get; set; }

  [Parameter]
  public int Level { get; set; }

  [Parameter]
  public QualityScaleVM? Scale { get; set; }

  [Inject]
  private IStringLocalizer<Strings> Strings { get; set; } = default!;

  protected override void OnParametersSet()
  {
    base.OnParametersSet();

    // Unsubscribe from previous factor
    if (_previousFactor != null)
    {
      _previousFactor.PropertyChanged -= OnFactorPropertyChanged;
    }

    // Subscribe to new factor
    if (Factor != null)
    {
      Factor.PropertyChanged -= OnFactorPropertyChanged; // Prevent double subscription
      Factor.PropertyChanged += OnFactorPropertyChanged;
      _previousFactor = Factor;
    }
  }

  private IQualityNodeVM? _previousFactor;

  private void OnFactorPropertyChanged(object? sender, PropertyChangedEventArgs e)
  {
    // Re-render when Value or Reliability changes (from evaluation)
    if (e.PropertyName == nameof(IQualityNodeVM.Value) ||
        e.PropertyName == nameof(IQualityNodeVM.Reliability))
    {
      InvokeAsync(StateHasChanged);
    }
  }

  private string? GetBackgroundColor()
  {
    var color = Factor?.BackgroundColor;
    if (string.IsNullOrEmpty(color))
      return null;

    // Convert named colors to hex or keep as-is
    // You might need to add color mapping here
    return color;
  }

  private void OnGradeChanged(QualityMeasureVM measure, ChangeEventArgs e)
  {
    var newGrade = e.Value?.ToString();
    if (measure.Grade != newGrade)
    {
      measure.Grade = newGrade;
      // Note: StateHasChanged is called via PropertyChanged event
    }
  }

  private void OnWeightChanged(ChangeEventArgs e)
  {
    if (Factor != null && int.TryParse(e.Value?.ToString(), out var newWeight))
    {
      if (Factor.Weight != newWeight)
      {
        Factor.Weight = newWeight;
        // Note: StateHasChanged is called via PropertyChanged event
      }
    }
  }

  private void OnCommentChanged(ChangeEventArgs e)
  {
    if (Factor != null)
    {
      var newComment = e.Value?.ToString();
      if (Factor.Comment != newComment)
      {
        Factor.Comment = newComment;
        StateHasChanged();
      }
    }
  }

  public void Dispose()
  {
    if (_previousFactor != null)
    {
      _previousFactor.PropertyChanged -= OnFactorPropertyChanged;
    }
  }
}